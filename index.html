<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player HLS Universal (Teste)</title>
    <!-- Certifique-se que o caminho para hls.min.js está correto -->
    <!-- Se hls.min.js estiver em /js/hls.min.js no seu site -->
    <script src="/js/hls.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f6f8; color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 720px; margin-bottom: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-top: 0; margin-bottom: 25px; font-size: 1.8em; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; font-size: 0.95em; }
        input[type="text"], input[type="url"] {
            width: calc(100% - 24px);
            padding: 10px 12px;
            margin-bottom: 18px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="url"]:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #2980b9; }
        #videoContainer { margin-top: 25px; background-color: #000; border-radius: 5px; overflow: hidden; }
        video { width: 100%; max-height: 500px; display: block; /* Muted por padrão para ajudar no autoplay */ }
        .error-message { color: #e74c3c; background-color: #fcecea; border: 1px solid #f6c0ba; padding: 10px; border-radius: 5px; margin-top: 15px; text-align: center; font-size: 0.9em; }
        .info-message { color: #2980b9; background-color: #eaf5fb; border: 1px solid #b8d9ec; padding: 10px; border-radius: 5px; margin-top: 15px; text-align: center; font-size: 0.9em; }
        .footer { margin-top: auto; padding: 15px; text-align: center; font-size: 0.85em; color: #777; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Player HLS Universal</h1>
        <p class="info-message">Cole a URL do M3U8 e, opcionalmente, a URL da página onde o vídeo original está para simular o Referer.</p>

        <label for="m3u8Url">URL do M3U8 Original:</label>
        <input type="url" id="m3u8Url" placeholder="https://cdn.example.com/path/to/video.m3u8" required>

        <label for="targetPageUrl">URL da Página Alvo (Opcional - para Referer):</label>
        <input type="url" id="targetPageUrl" placeholder="https://sitealvo.com/pagina-do-video">

        <button onclick="loadPlayer()">Carregar Vídeo</button>

        <div id="videoContainer">
            <video id="hlsPlayer" controls autoplay muted playsinline></video>
        </div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="debugInfo" style="margin-top:10px; font-size:0.8em; word-break:break-all;"></div>
    </div>

    <div class="footer">
        Player HLS para teste. Hospedado em <a href="https://meu-player-anroll.onrender.com" target="_blank">meu-player-anroll.onrender.com</a>.
    </div>

    <script>
        let hlsInstance = null;
        const videoElement = document.getElementById('hlsPlayer');
        const m3u8UrlInput = document.getElementById('m3u8Url');
        const targetPageUrlInput = document.getElementById('targetPageUrl');
        const errorMessageElement = document.getElementById('errorMessage');
        const debugInfoElement = document.getElementById('debugInfo');

        // Autoplay com som geralmente é bloqueado. Muted ajuda.
        // playsinline é bom para iOS.

        function showDebug(message) {
            // debugInfoElement.innerHTML += message + "<br>";
            console.log("DEBUG: " + message);
        }

        function showError(message) {
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
            console.error("PLAYER ERROR: " + message);
        }

        function clearError() {
            errorMessageElement.textContent = '';
            errorMessageElement.style.display = 'none';
        }

        function loadPlayer() {
            clearError();
            // debugInfoElement.innerHTML = ""; // Limpa debug anterior
            showDebug("Botão Carregar Vídeo clicado.");

            const originalM3u8Url = m3u8UrlInput.value.trim();
            const targetPageUrl = targetPageUrlInput.value.trim();

            if (!originalM3u8Url) {
                showError('Por favor, insira uma URL M3U8 válida.');
                return;
            }
            try {
                new URL(originalM3u8Url); // Validação básica de URL
            } catch (e) {
                showError('A URL do M3U8 parece ser inválida.');
                return;
            }
            if (targetPageUrl) {
                try {
                    new URL(targetPageUrl); // Validação básica de URL
                } catch (e) {
                    showError('A URL da Página Alvo parece ser inválida (se fornecida).');
                    return;
                }
            }


            if (hlsInstance) {
                showDebug("Destruindo instância HLS anterior.");
                hlsInstance.destroy();
                hlsInstance = null;
            }

            // Caminho para o proxy.php na raiz do seu site
            let proxyRequestUrl = `/proxy.php?url=${encodeURIComponent(originalM3u8Url)}`;
            if (targetPageUrl) {
                proxyRequestUrl += `&page_url=${encodeURIComponent(targetPageUrl)}`;
            }

            showDebug(`URL do Proxy construída: ${proxyRequestUrl}`);

            if (Hls.isSupported()) {
                showDebug("HLS.js é suportado. Criando nova instância.");
                hlsInstance = new Hls({
                    // debug: true, // Habilite para logging MUITO detalhado do HLS.js no console
                    enableWorker: true,
                    // Tentar configurações mais agressivas para recuperação de erros de rede
                    manifestLoadingMaxRetry: 5,
                    manifestLoadingRetryDelay: 1000,
                    levelLoadingMaxRetry: 5,
                    levelLoadingRetryDelay: 1000,
                    fragLoadingMaxRetry: 6, // Mais tentativas para fragmentos
                    fragLoadingRetryDelay: 1000,
                });

                showDebug(`Carregando source: ${proxyRequestUrl}`);
                hlsInstance.loadSource(proxyRequestUrl);
                hlsInstance.attachMedia(videoElement);

                hlsInstance.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    showDebug('Manifesto HLS parseado com sucesso. Níveis disponíveis: ' + data.levels.length);
                    videoElement.play().catch(error => {
                        showDebug(`Autoplay falhou ou foi bloqueado pelo navegador: ${error.message}. O usuário pode precisar interagir.`);
                        // Não mostrar como erro fatal, apenas um aviso
                    });
                });

                hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                    let errorMsg = `Erro HLS.js: Tipo: ${data.type}, Detalhes: ${data.details}`;
                    if(data.reason) errorMsg += `, Razão: ${data.reason}`;
                    
                    showDebug(`HLS.js Error Event: ${JSON.stringify(data)}`);

                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                errorMsg += " (Erro de rede. Verifique a URL M3U8, a URL da página alvo, e se o proxy e o CDN estão acessíveis.)";
                                if (data.details === 'manifestLoadError' || data.details === 'manifestLoadTimeOut'){
                                     errorMsg += " Falha ao carregar o manifesto principal.";
                                } else if (data.details === 'levelLoadError' || data.details === 'levelLoadTimeOut'){
                                     errorMsg += " Falha ao carregar um manifesto de nível de qualidade.";
                                } else if (data.details === 'fragLoadError' || data.details === 'fragLoadTimeOut'){
                                     errorMsg += " Falha ao carregar um segmento de vídeo.";
                                }
                                // Tentar reiniciar o carregamento pode ajudar em alguns casos de rede instável
                                // hlsInstance.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                errorMsg += " (Erro de mídia. O conteúdo do vídeo pode estar corrompido ou em formato não suportado.)";
                                if(data.details === 'bufferAppendError' || data.details === 'bufferNudgeOnStall') {
                                    errorMsg += " Tentando recuperar...";
                                    hlsInstance.recoverMediaError();
                                } else if (data.details === 'manifestIncompatibleCodecsError') {
                                    errorMsg += " Codecs incompatíveis no manifesto.";
                                    hlsInstance.destroy(); // Não recuperável
                                } else {
                                     hlsInstance.destroy(); // Não recuperável
                                }
                                break;
                            default:
                                errorMsg += " (Erro fatal desconhecido. O HLS.js foi destruído.)";
                                hlsInstance.destroy();
                                break;
                        }
                    } else {
                         errorMsg += " (Erro não fatal)";
                    }
                    showError(errorMsg);
                });

            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                showDebug("HLS.js não suportado, tentando suporte HLS nativo do navegador (ex: Safari).");
                videoElement.src = proxyRequestUrl; // O proxy ainda é usado aqui
                videoElement.addEventListener('loadedmetadata', function() {
                    showDebug("Metadados carregados (nativo). Tentando tocar.");
                    videoElement.play().catch(error => {
                        showDebug(`Autoplay nativo falhou ou foi bloqueado: ${error.message}`);
                    });
                });
                videoElement.addEventListener('error', (e) => {
                    let errorText = "Erro no player de vídeo nativo: ";
                    if (videoElement.error) {
                        switch (videoElement.error.code) {
                            case videoElement.error.MEDIA_ERR_ABORTED: errorText += 'Abortado pelo usuário.'; break;
                            case videoElement.error.MEDIA_ERR_NETWORK: errorText += 'Erro de rede.'; break;
                            case videoElement.error.MEDIA_ERR_DECODE:  errorText += 'Erro de decodificação.'; break;
                            case videoElement.error.MEDIA_ERR_SRC_NOT_SUPPORTED: errorText += 'Formato não suportado ou URL inválida.'; break;
                            default: errorText += 'Erro desconhecido (' + videoElement.error.code + ').'; break;
                        }
                    } else {
                        errorText += "Informação de erro não disponível.";
                    }
                    showError(errorText);
                });
            } else {
                showError('Seu navegador não suporta streaming HLS, nem com HLS.js nem nativamente.');
            }
        }

        // Opcional: Tentar carregar a partir de parâmetros da URL ao carregar a página
        // Ex: https://meu-player-anroll.onrender.com/?m3u8=URL_DO_M3U8&page_url=URL_DA_PAGINA
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const m3u8FromQuery = params.get('m3u8');
            const pageUrlFromQuery = params.get('page_url');

            if (m3u8FromQuery) {
                m3u8UrlInput.value = m3u8FromQuery;
                if (pageUrlFromQuery) {
                    targetPageUrlInput.value = pageUrlFromQuery;
                }
                showDebug("Carregando vídeo a partir dos parâmetros da URL.");
                loadPlayer();
            }
        });

    </script>
</body>
</html>
